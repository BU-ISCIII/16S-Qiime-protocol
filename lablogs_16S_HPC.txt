# ANALYSIS
# Please don't run this very script at 23:59, just in case
# Generates the directory where the analysis will be held
# Generates the sample name list
# Generates the directory with renamed links for each read
# Generates the manifest file to import the sequences to qiime2
mkdir -p $(date '+%Y%m%d')_ANALYSIS01_16S
ls ../RAW/*.gz | cut -d "/" -f3 | cut -d "_" -f1 | sort -u > samples_id.txt
mkdir -p 00-reads
cd 00-reads; cat ../samples_id.txt | xargs -I % echo "ln -s ../../RAW/%_*R1*.fastq.gz %_R1.fastq.gz" | bash;
cat ../samples_id.txt | xargs -I % echo "ln -s ../../RAW/%_*R2*.fastq.gz %_R2.fastq.gz" | bash; cd -
printf "sample-id\tforward-absolute-filepath\treverse-absolute-filepath\n" > manifest.tsv
cat samples_id.txt | xargs -I % printf "%\t$(pwd)/$(date '+%Y%m%d')_ANALYSIS01_16S/03-fastp_preprocess/%/%_R1_filtered.fq.gz\t$(pwd)/$(date '+%Y%m%d')_ANALYSIS01_16S/03-fastp_preprocess/%/%_R2_filtered.fq.gz\n" >> manifest.tsv 

# ANALYSIS01_16S
# Generates the directory structure for the analysis
# Generates a symbolic link to the sample-list, named samples directory and manifest
mkdir 01-fastQC_previous	
mkdir 02-cutadapt_remove_primers	
mkdir 03-fastp_preprocess	
mkdir 04-fastQC_posterior	
mkdir 05-qiime2_import	
mkdir 06-qiime2_denoise_cluster	
mkdir 07-qiime2_taxonomy	
mkdir 08-qiime2_filt_mit_chl	
mkdir 09-qiime2_taxabarplots
mkdir 09-qiime2_taxabarplots/01-Full
mkdir 09-qiime2_taxabarplots/02-Filtered
mkdir 10-qiime2_absoluteNumbers
mkdir 10-qiime2_absoluteNumbers/01-Full
mkdir 10-qiime2_absoluteNumbers/02-Filtered
mkdir 11-qiime2_phylogeny
mkdir 11-qiime2_phylogeny/01-Full
mkdir 11-qiime2_phylogeny/02-Filtered
mkdir 12-qiime2_diversity
mkdir 12-qiime2_diversity/01-Full
mkdir 12-qiime2_diversity/02-Filtered
mkdir 13-qiime2_rarefaction
mkdir 13-qiime2_rarefaction/01-Full
mkdir 13-qiime2_rarefaction/02-Filtered
mkdir 14-qiime2_gneiss_differential_abundance
mkdir 14-qiime2_gneiss_differential_abundance/01-Full
mkdir 14-qiime2_gneiss_differential_abundance/02-Filtered
mkdir 15-qiime2_ANCOM
mkdir 15-qiime2_ANCOM/01-Full
mkdir 15-qiime2_ANCOM/02-Filtered
mkdir 99-stats
ln -s ../00-reads .
ln -s ../samples_id.txt .
ln -s ../manifest.tsv .
ln -s ../metadata.tsv .

# 01-fastQC_previous
# fastQC to assess the raw reads quality
# conda activate quality_control
cat ../samples_id.txt | xargs -I % echo "mkdir %; qsub -V -b y -j y -cwd -N PRE_FQC_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 fastqc -o % ../00-reads/%*.fastq.gz" > _01_fastqc_pre_trimming.sh

# 02-cutadapt_remove_primers
# cutadapt to remove the sequencing primers
# conda activate quality_control
cat ../samples_id.txt | xargs -I % echo "mkdir %; qsub -V -b y -j y -cwd -N CUTADPT_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 cutadapt -a {ADAPTER_R1} -A {ADAPTER_R2} --json %/%.cutadapt.json -o %/%_adapter_removed_R1.fastq.gz -p %/%_adapter_removed_R2.fastq.gz ../00-reads/%_R1.fastq.gz ../00-reads/%_R2.fastq.gz" > _01_cutadapt.sh

# 03-fastp_preprocess
# fastp to trim the raw sequences and improve quality
# conda activate quality_control
cat ../samples_id.txt | xargs -I % echo "mkdir %; qsub -V -b y -j y -cwd -N FASTP_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 fastp -i ../02-cutadapt_remove_primers/%/%_adapter_removed_R1.fastq.gz -I ../02-cutadapt_remove_primers/%/%_adapter_removed_R2.fastq.gz --trim_poly_x --cut_front --cut_tail --cut_mean_quality 15 --length_required 220 --qualified_quality_phred 15 --unqualified_percent_limit 40 --cut_window_size 4 --html %/%_trim_report_fastp.html --json %/%_trim_report_fastp.json -o %/%_R1_filtered.fq.gz -O %/%_R2_filtered.fq.gz" > _01_fastp.sh

# 04-fastQC_posterior
# fastQC to asses the trimmed reads quality	
# conda activate quality_control
cat ../samples_id.txt | xargs -I % echo "mkdir %;  qsub -V -b y -j y -cwd -N POST_FQC_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 fastqc -o % ../03-fastp_preprocess/%/%_*_filtered.fq.gz" > _01_fastqc_post_trimming.sh

# 05-qiime2_import
# Import the sequences in the manifest into a qiime2 object
# Generate the visual files for the created objects: importseqs
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_IMPORT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools import --type \"SampleData[PairedEndSequencesWithQuality]\" --input-path ../manifest.tsv --output-path paired-end-demux.qza --input-format PairedEndFastqManifestPhred33V2" > _01_qiime2_import.sh
echo "qsub -V -b y -j y -cwd -N Q2_IMPORT_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime demux summarize --i-data paired-end-demux.qza --o-visualization paired-end-demux.qzv" > _02_qiime2_import_visualfile.sh

# 06-qiime2_denoise_cluster
# Use the dada2 module in qiime2 to denoise, ligate and cluster the reads
# Generate the visual files for the created objects: repseqs, stats, feature table, tabulated repseqs, summarized feature table
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_DADA2 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime dada2 denoise-paired --i-demultiplexed-seqs ../05-qiime2_import/paired-end-demux.qza --p-trunc-len-f 220 --p-trunc-len-r 220 --p-n-threads 0 --p-max-ee-f 2 --p-max-ee-r 2 --o-representative-sequences rep_seqs_full.qza --o-table feature_table_full.qza --o-denoising-stats stats_dada2.qza" > _01_qiime2_dada2.sh
echo "qsub -V -b y -j y -cwd -N Q2_REPSEQS_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime metadata tabulate --m-input-file rep_seqs_full.qza --o-visualization rep_seqs_full.qzv" > _02_qiime2_dada2_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_STATS_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime metadata tabulate --m-input-file stats_dada2.qza --o-visualization stats_dada2.qzv" >> _02_qiime2_dada2_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_STATS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path stats_dada2.qza --output-path ../99-stats" >> _02_qiime2_dada2_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_FTABLE_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime metadata tabulate --m-input-file feature_table_full.qza --o-visualization feature_table_full.qzv" >> _02_qiime2_dada2_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_FTABLE_SUMM_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime feature-table summarize --i-table feature_table_full.qza --o-visualization feature_table_full_summarized.qzv --m-sample-metadata-file ../metadata.tsv" >> _02_qiime2_dada2_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_TAB_REPSEQS_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime feature-table tabulate-seqs --i-data rep_seqs_full.qza --o-visualization feature_table_tabulated_seqs.qzv" >> _02_qiime2_dada2_visualfiles.sh

# 07-qiime2_taxonomy
# Use the previously-trained Naive Bayes classifier to identify the rep seqs
# Generate the visual files for the created objects: taxonomy
# due to problems with the env variable, _01_qiime2_taxonomic_identification.sh calls _00_taxonomic_identification.sh
# conda activate qiime2021.2
echo "export TMPDIR=/scratch; qiime feature-classifier classify-sklearn --i-classifier /data/bi/references/QIIME2/2021.2_bayes_silva.qza --i-reads ../06-qiime2_denoise_cluster/rep_seqs_full.qza --p-confidence 0.8 --o-classification taxonomy.qza" > _00_taxonomic_identification.sh
echo "qsub -V -b y -j y -cwd -N Q2_IDENTIFICATE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 bash _00_taxonomic_identification.sh" > _01_qiime2_taxonomic_identification.sh
echo "qsub -V -b y -j y -cwd -N Q2_TAX_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime metadata tabulate --m-input-file taxonomy.qza --o-visualization taxonomy.qzv" > _02_qiime2_taxonomic_visual_export.sh
echo "qsub -V -b y -j y -cwd -N Q2_TAX_EXPORT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path taxonomy.qza --output-path taxonomy_table" >> _02_qiime2_taxonomic_visual_export.sh

# 07-qiime2_taxonomy_BLAST
# Use SILVA 13_8 taxonomy and sequences to identify the rep seqs through mapping
# Generate the visual files for the created objects: taxonomy
# due to problems with the env variable, _01_qiime2_taxonomic_identification.sh calls _00_taxonomic_identification.sh
# conda activate qiime2021.2
echo "export TMPDIR=/scratch; qiime feature-classifier classify-consensus-blast --i-query ../06-qiime2_denoise_cluster/rep_seqs_full.qza --i-reference-reads /data/bi/references/QIIME2/Silva_138_99_sequences.qza --i-reference-taxonomy /data/bi/references/QIIME2/Silva_138_99_taxonomy.qza --o-classification taxonomy.qza" > _00_taxonomic_identification.sh
echo "qsub -V -b y -j y -cwd -N Q2_IDENTIFICATE_BLAST -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 bash _00_taxonomic_identification.sh" > _01_qiime2_taxonomic_identification.sh
echo "qsub -V -b y -j y -cwd -N Q2_TAX_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime metadata tabulate --m-input-file taxonomy.qza --o-visualization taxonomy.qzv" > _02_qiime2_taxonomic_visual_export.sh
echo "qsub -V -b y -j y -cwd -N Q2_TAX_EXPORT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path taxonomy.qza --output-path taxonomy_table" >> _02_qiime2_taxonomic_visual_export.sh

# 08-qiime2_filt_mit_chl
# Filter mitochondria and chloroplast from the feature table and rep-seqs
# Generate the visual files for the created objects: filtered feature table, summarized filtered feature table, filtered rep seqs 
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_FILTER -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa filter-table --i-table ../06-qiime2_denoise_cluster/feature_table_full.qza --i-taxonomy ../07-qiime2_taxonomy/taxonomy.qza --p-exclude mitochondria,chloroplast --o-filtered-table feature_table_filtered.qza" > _01_qiime2_filter_table_repseqs.sh
echo "qsub -V -b y -j y -cwd -N Q2_REPSEQS_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa filter-seqs --i-sequences ../06-qiime2_denoise_cluster/rep_seqs_full.qza --i-taxonomy ../07-qiime2_taxonomy/taxonomy.qza --p-exclude mitochondria,chloroplast --o-filtered-sequences rep_seqs_filtered.qza" >> _01_qiime2_filter_table_repseqs.sh
echo "qsub -V -b y -j y -cwd -N Q2_FTABLE_FILT_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime metadata tabulate --m-input-file feature_table_filtered.qza --o-visualization feature_table_filtered.qzv" > _02_qiime2_filtered_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_FTABLE_FILT_SUMM_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime feature-table summarize --i-table feature_table_filtered.qza --o-visualization feature_table_filtered_summarized.qzv --m-sample-metadata-file ../metadata.tsv" >> _02_qiime2_filtered_visualfiles.sh
echo "qsub -V -b y -j y -cwd -N Q2_REPSEQS_FILT_VISUAL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime feature-table tabulate-seqs --i-data rep_seqs_filtered.qza --o-visualization rep_seqs_filtered.qzv" >> _02_qiime2_filtered_visualfiles.sh

# 09-qiime2_taxabarplots/01-Full
# Generates the visual file with the barplot for the full (unfiltered) feature tables
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_BARPLOT_FULL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa barplot --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --i-taxonomy ../../07-qiime2_taxonomy/taxonomy.qza --m-metadata-file ../../metadata.tsv --o-visualization taxa_barplots_full.qzv" > _01_qiime2_taxa_barplots_full.sh

# 09-qiime2_taxabarplots/02-Filtered
# Generates the visual file with the barplot for the filtered feature tables
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_BARPLOT_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa barplot --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --i-taxonomy ../../07-qiime2_taxonomy/taxonomy.qza --m-metadata-file ../../metadata.tsv --o-visualization taxa_barplots_filtered.qzv" > _01_qiime2_filter_taxa_barplots.sh

# 10-qiime2_absoluteNumbers/01-Full
# Generates a table (row=samples; column=taxa) with absolute hit numbers collapsed to lvl 6 and 7, species from the full (unfiltered) table
# conda activate qiime2021.2
mkdir lvl_6_biom
mkdir lvl_7_biom
ln -s /data/bi/pipelines/16S-Qiime-protocol/process_table.py  process_table.py
echo "qsub -V -b y -j y -cwd -N Q2_COLLAPSE_FULL_TABLE_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa collapse --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --i-taxonomy ../../07-qiime2_taxonomy/taxonomy.qza --p-level 7 --o-collapsed-table collapsed_full_table_lvl_7.qza" > _01_qiime2_collapse_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_COLLAPSE_FULL_TABLE_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa collapse --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --i-taxonomy ../../07-qiime2_taxonomy/taxonomy.qza --p-level 6 --o-collapsed-table collapsed_full_table_lvl_6.qza" >> _01_qiime2_collapse_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_FULL_BIOM_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path collapsed_full_table_lvl_7.qza --output-path ./lvl_7_biom" > _02_qiime2_export_biom_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_FULL_BIOM_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path collapsed_full_table_lvl_6.qza --output-path ./lvl_6_biom" >> _02_qiime2_export_biom_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_CONVERT_FULL_TABLE_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 biom convert --input-fp lvl_7_biom/feature-table.biom --output-fp long_full_table_lvl_7.tsv --to-tsv" > _03_qiime2_biom_to_tsv.sh
echo "qsub -V -b y -j y -cwd -N Q2_CONVERT_FULL_TABLE_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 biom convert --input-fp lvl_6_biom/feature-table.biom --output-fp long_full_table_lvl_6.tsv --to-tsv" >> _03_qiime2_biom_to_tsv.sh
echo "qsub -V -b y -j y -cwd -N PY_TRANSPOSE_FULL_TABLE_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python process_table.py long_full_table_lvl_7.tsv absolute_numbers_taxonomy_lvl_7_full.tsv" > _04_python_transpose_tsv.sh
echo "qsub -V -b y -j y -cwd -N PY_TRANSPOSE_FULL_TABLE_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python process_table.py long_full_table_lvl_6.tsv absolute_numbers_taxonomy_lvl_6_full.tsv" >> _04_python_transpose_tsv.sh

# 10-qiime2_absoluteNumbers/02-Filtered
# Generates a table (row=samples; column=taxa) with absolute hit numbers collapsed to lvl 7, species from the filtered table
# conda activate qiime2021.2
mkdir lvl_6_biom
mkdir lvl_7_biom
ln -s /data/bi/pipelines/16S-Qiime-protocol/process_table.py process_table.py
echo "qsub -V -b y -j y -cwd -N Q2_COLLAPSE_FILT_TABLE_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa collapse --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --i-taxonomy ../../07-qiime2_taxonomy/taxonomy.qza --p-level 7 --o-collapsed-table collapsed_filtered_table_lvl_7.qza" > _01_qiime2_collapse_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_COLLAPSE_FILT_TABLE_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime taxa collapse --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --i-taxonomy ../../07-qiime2_taxonomy/taxonomy.qza --p-level 6 --o-collapsed-table collapsed_filtered_table_lvl_6.qza" >> _01_qiime2_collapse_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_FILT_BIOM_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path collapsed_filtered_table_lvl_7.qza --output-path ./lvl_7_biom" > _02_qiime2_export_biom_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_FILT_BIOM_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path collapsed_filtered_table_lvl_6.qza --output-path ./lvl_6_biom" >> _02_qiime2_export_biom_table.sh
echo "qsub -V -b y -j y -cwd -N Q2_CONVERT_FILT_TABLE_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 biom convert --input-fp lvl_7_biom/feature-table.biom --output-fp long_filtered_table_lvl_7.tsv --to-tsv" > _03_qiime2_biom_to_tsv.sh
echo "qsub -V -b y -j y -cwd -N Q2_CONVERT_FILT_TABLE_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 biom convert --input-fp lvl_6_biom/feature-table.biom --output-fp long_filtered_table_lvl_6.tsv --to-tsv" >> _03_qiime2_biom_to_tsv.sh
echo "qsub -V -b y -j y -cwd -N PY_TRANSPOSE_FILT_TABLE_7 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python process_table.py long_filtered_table_lvl_7.tsv absolute_numbers_taxonomy_lvl_7_filtered.tsv" > _04_python_transpose_tsv.sh
echo "qsub -V -b y -j y -cwd -N PY_TRANSPOSE_FILT_TABLE_6 -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python process_table.py long_filtered_table_lvl_6.tsv absolute_numbers_taxonomy_lvl_6_filtered.tsv" >> _04_python_transpose_tsv.sh

# 11-qiime2_phylogeny/01-Full
# Calculates the phylogenetic tree for the full (unfiltered) rep-seqs 
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_PHYLO_FULL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime phylogeny align-to-tree-mafft-fasttree --i-sequences ../../06-qiime2_denoise_cluster/rep_seqs_full.qza --o-alignment aligned_rep_seqs_full.qza --o-masked-alignment masked_aligned_rep_seqs_full.qza --o-tree unrooted_tree_full.qza --o-rooted-tree rooted_tree_full.qza" > _01_qiime2_align.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_ROOTREE_FULL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path rooted_tree_full.qza  --output-path rooted_tree_newick" > _02_qiime2_export_tree.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_UNROOTREE_FULL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path unrooted_tree_full.qza  --output-path unrooted_tree_newick" >> _02_qiime2_export_tree.sh

# 11-qiime2_phylogeny/02-Filtered
# Calculates the phylogenetic tree for the filtered rep-seqs 
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_PHYLO_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime phylogeny align-to-tree-mafft-fasttree --i-sequences ../../08-qiime2_filt_mit_chl/rep_seqs_filtered.qza --o-alignment aligned_filtered_rep_seqs.qza --o-masked-alignment masked_aligned_filtered_rep_seqs.qza --o-tree unrooted_tree_filtered.qza --o-rooted-tree rooted_tree_filtered.qza" > _01_qiime2_align_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_ROOTREE_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path rooted_tree_filtered.qza  --output-path rooted_tree_newick" > _02_qiime2_export_tree.sh
echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_UNROOTREE_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path unrooted_tree_filtered.qza  --output-path unrooted_tree_newick" >> _02_qiime2_export_tree.sh

# 12-qiime2_diversity/01-Full
# Calculates the diversity parameters for the full (unfiltered) table using the phylogeny
# conda activate qiime2021.2
# Must be provided with a number for the sampling depth. Value is extracted from the full summarized table
echo "qsub -V -b y -j y -cwd -N Q2_PHYLOGENETIC_DIVERSITY_FULL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity core-metrics-phylogenetic --i-phylogeny ../../11-qiime2_phylogeny/01-Full/rooted_tree_full.qza --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --p-sampling-depth $1 --m-metadata-file ../../metadata.tsv --output-dir alpha_diversity_full" > _01_qiime2_alpha_diversity_full.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_PIELOU -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --p-metric pielou_e --o-alpha-diversity pielou_index_full.qza" >> _01_qiime2_alpha_diversity_full.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_SIMPSON -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --p-metric simpson --o-alpha-diversity simpson_index_full.qza" >> _01_qiime2_alpha_diversity_full.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_OBSOTUS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --p-metric observed_features --o-alpha-diversity observed_features_full.qza" >> _01_qiime2_alpha_diversity_full.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_DOMINANCE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --p-metric dominance --o-alpha-diversity dominance_index_full.qza" >> _01_qiime2_alpha_diversity_full.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_ENSPIE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --p-metric enspie --o-alpha-diversity enspie_index_full.qza" >> _01_qiime2_alpha_diversity_full.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_FAITH -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity alpha_diversity_full/faith_pd_vector.qza --m-metadata-file ../../metadata.tsv --o-visualization faith_pd_summarized_full.qzv" >  _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_SHANNON -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity alpha_diversity_full/shannon_vector.qza --m-metadata-file ../../metadata.tsv --o-visualization shannon_vector_summarized_full.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_PIELOU -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity pielou_index_full.qza --m-metadata-file ../../metadata.tsv --o-visualization pielou_index_full.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_SIMPSON -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity simpson_index_full.qza --m-metadata-file ../../metadata.tsv --o-visualization simpson_index_full.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_OBSOTUS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity observed_features_full.qza --m-metadata-file ../../metadata.tsv --o-visualization observed_features_full.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_DOMINANCE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity dominance_index_full.qza --m-metadata-file ../../metadata.tsv --o-visualization dominance_index_full.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FULL_VISUAL_ENSPIE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity enspie_index_full.qza --m-metadata-file ../../metadata.tsv --o-visualization enspie_index_full.qzv" >> _02_qiime2_alpha_diversity_visual.sh


# 12-qiime2_diversity/02-Filtered
# Calculates the diversity parameters for the filtered table using the phylogeny
# Must be provided with a number for the sampling depth. Value is extracted from the filtered summarized table
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_PHYLOGENETIC_DIVERSITY_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity core-metrics-phylogenetic --i-phylogeny ../../11-qiime2_phylogeny/02-Filtered/rooted_tree_filtered.qza --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --p-sampling-depth $1 --m-metadata-file ../../metadata.tsv --output-dir alpha_diversity_filtered" > _01_qiime2_alpha_diversity_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_PIELOU -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --p-metric pielou_e --o-alpha-diversity pielou_index_filtered.qza" >> _01_qiime2_alpha_diversity_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_SIMPSON -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --p-metric simpson --o-alpha-diversity simpson_index_filtered.qza" >> _01_qiime2_alpha_diversity_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_OBSOTUS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --p-metric observed_features --o-alpha-diversity observed_features_filtered.qza" >> _01_qiime2_alpha_diversity_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_DOMINANCE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --p-metric dominance --o-alpha-diversity dominance_index_filtered.qza" >> _01_qiime2_alpha_diversity_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_ENSPIE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --p-metric enspie --o-alpha-diversity enspie_index_filtered.qza" >> _01_qiime2_alpha_diversity_filtered.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_FAITH -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity alpha_diversity_filtered/faith_pd_vector.qza --m-metadata-file ../../metadata.tsv --o-visualization faith_pd_summarized_filtered.qzv" >  _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_SHANNON -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity alpha_diversity_filtered/shannon_vector.qza --m-metadata-file ../../metadata.tsv --o-visualization shannon_vector_summarized_filtered.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_PIELOU -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity pielou_index_filtered.qza --m-metadata-file ../../metadata.tsv --o-visualization pielou_index_filtered.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_SIMPSON -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity simpson_index_filtered.qza --m-metadata-file ../../metadata.tsv --o-visualization simpson_index_filtered.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_OBSOTUS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity observed_features_filtered.qza --m-metadata-file ../../metadata.tsv --o-visualization observed_features_filtered.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_DOMINANCE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity dominance_index_filtered.qza --m-metadata-file ../../metadata.tsv --o-visualization dominance_index_filtered.qzv" >> _02_qiime2_alpha_diversity_visual.sh
echo "qsub -V -b y -j y -cwd -N Q2_FILT_VISUAL_ENSPIE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-group-significance --i-alpha-diversity enspie_index_filtered.qza --m-metadata-file ../../metadata.tsv --o-visualization enspie_index_filtered.qzv" >> _02_qiime2_alpha_diversity_visual.sh

# 13-qiime2_rarefaction/01-Full
# Calculates the rarefaction curve for the full (unfiltered) table
# Must be provided with a number for max-depth, extracted from the full summarized table
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_RAREFACTION_FULL -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-rarefaction --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --i-phylogeny ../../11-qiime2_phylogeny/01-Full/rooted_tree_full.qza --p-max-depth $1 --p-metrics shannon faith_pd pielou_e simpson observed_features dominance enspie --m-metadata-file ../../metadata.tsv --o-visualization alpha_rarefaction_full.qzv" > _01_qiime2_alpha_rarefaction.sh

# 13-qiime2_rarefaction/02-Filtered
# Calculates the rarefaction curve for the full (unfiltered) table
# Must be provided with a number for max-depth, extracted from the filtered summarized table
# conda activate qiime2021.2
echo "qsub -V -b y -j y -cwd -N Q2_RAREFACTION_FILT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime diversity alpha-rarefaction --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --i-phylogeny ../../11-qiime2_phylogeny/02-Filtered/rooted_tree_filtered.qza --p-max-depth $1 --p-metrics shannon faith_pd pielou_e simpson observed_features dominance enspie --m-metadata-file ../../metadata.tsv --o-visualization alpha_rarefaction_filtered.qzv" > _01_qiime_alpha_rarefaction_filtered.sh

# 14-qiime2_gneiss_differential_abundance/01-Full
echo "qsub -V -b y -j y -cwd -N Q2_GNEISS_FULL_HIERARCHY -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime gneiss correlation-clustering --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --o-clustering hierarchy_full.qza" > _01_qiime_gneiss_build_hierarchy_full.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N Q2_GNEISS_FULL_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime gneiss dendrogram-heatmap --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --i-tree hierarchy_full.qza --m-metadata-file ../../metadata.tsv --m-metadata-column % --p-color-map seismic --o-visualization heatmap_%_full.qzv" > _02_qiime_gneiss_heatmap_full.sh

# 14-qiime2_gneiss_differential_abundance/02-Filtered
echo "qsub -V -b y -j y -cwd -N Q2_GNEISS_FILT_HIERARCHY -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime gneiss correlation-clustering --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --o-clustering hierarchy_filtered.qza" > _01_qiime_gneiss_build_hierarchy_filtered.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N Q2_GNEISS_FILT_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime gneiss dendrogram-heatmap --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --i-tree hierarchy_filtered.qza --m-metadata-file ../../metadata.tsv --m-metadata-column % --p-color-map seismic --o-visualization heatmap_%_filtered.qzv" > _02_qiime_gneiss_heatmap_filtered.sh

# 15-qiime2_ANCOM/01-Full
ln -s /data/bi/pipelines/16S-Qiime-protocol/Identify_ANCOM.py Identify_ANCOM.py
echo "qsub -V -b y -j y -cwd -N Q2_FULL_PSEUDOCOUNT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime composition add-pseudocount --i-table ../../06-qiime2_denoise_cluster/feature_table_full.qza --o-composition-table composition_table_full.qza" > _01_qiime_pseudocount_full.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N Q2_ANCOM_FULL_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime composition ancom --i-table composition_table_full.qza --m-metadata-file ../../metadata.tsv --m-metadata-column % --o-visualization ancom_%_full.qzv" > _02_qiime_ancom_full.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_ANCOM_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path ancom_%_full.qzv --output-path ancom_%_full_dir" > _03_qiime_export_ancom_full.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N PY_GENERATE_ANCOM_RESULTS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python3 Identify_ANCOM.py --taxonomy ../../07-qiime2_taxonomy/taxonomy_table/taxonomy.tsv --data ancom_%_full_dir/data.tsv --ancom ancom_%_full_dir/ancom.tsv --percent-abundances ancom_%_full_dir/percent-abundances.tsv" > _04_python_get_full_abundance_tables.sh 

# 15-qiime2_ANCOM/02-Filtered 
ln -s /data/bi/pipelines/16S-Qiime-protocol/Identify_ANCOM.py Identify_ANCOM.py
echo "qsub -V -b y -j y -cwd -N Q2_FILT_PSEUDOCOUNT -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime composition add-pseudocount --i-table ../../08-qiime2_filt_mit_chl/feature_table_filtered.qza --o-composition-table composition_table_filt.qza" > _01_qiime_pseudocount_filt.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N Q2_ANCOM_FILT_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime composition ancom --i-table composition_table_filt.qza --m-metadata-file ../../metadata.tsv --m-metadata-column % --o-visualization ancom_%_filt.qzv" > _02_qiime_ancom_filt.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N Q2_EXPORT_ANCOM_% -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 qiime tools export --input-path ancom_%_filt.qzv --output-path ancom_%_filt_dir" > _03_qiime_export_ancom_filt.sh
head -n 1 ../../metadata.tsv | xargs -n1 | tail -n +2 | xargs -I % echo "qsub -V -b y -j y -cwd -N PY_GENERATE_ANCOM_RESULTS -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python3 Identify_ANCOM.py --taxonomy ../../07-qiime2_taxonomy/taxonomy_table/taxonomy.tsv --data ancom_%_filt_dir/data.tsv --ancom ancom_%_filt_dir/ancom.tsv --percent-abundances ancom_%_filt_dir/percent-abundances.tsv" > _04_python_get_filt_abundance_tables.sh 

# 99-stats
# bring necessary files
ln -s /data/bi/pipelines/16S-Qiime-protocol/process_table.py 
ln -s ../01-fastQC_previous .
ln -s ../02-cutadapt_remove_primers .
ln -s ../03-fastp_preprocess .
ln -s ../04-fastQC_posterior .
# multiQC to assess the general quality of the reads
echo "qsub -V -b y -j y -cwd -N MULTIQC -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 multiqc . -o ." > _01_multiqc.sh 
# generate the read balance with the ad-hoc python script
echo "qsub -V -b y -j y -cwd -N READ_BALANCE -q all.q@obelix09,all.q@obelix10,all.q@obelix11,all.q@obelix12,all.q@obelix13,all.q@obelix14,all.q@obelix15 python generate_read_balance.py multiqc_data/multiqc_data.json stats.tsv" > _02_read_balance.sh
